---
description: 要件を言い直し、リスクを評価し、ステップバイステップの実装計画を作成します。コードに触れる前にユーザーの確認を待ってください。
---

# プランコマンド

このコマンドは **planner** エージェントを呼び出して、コードを書く前に包括的な実装計画を作成します。

## このコマンドが行うこと

1. **要件を言い直す** - 何を構築する必要があるかを明確にする
2. **リスクを特定する** - 潜在的な問題とブロッカーを浮き彫りにする
3. **ステッププランを作成** - 実装をフェーズに分解する
4. **確認を待つ** - 進める前にユーザーの承認を受ける必要があります

## いつ使用するか

以下の場合に `/plan` を使用してください:
- 新機能を開始するとき
- 大きなアーキテクチャ変更を行うとき
- 複雑なリファクタリングに取り組むとき
- 複数のファイル/コンポーネントが影響を受ける
- 要件が不明確または曖昧な場合

## How It Works

The planner agent will:

1. **Analyze the request** and restate requirements in clear terms
2. **Break down into phases** with specific, actionable steps
3. **Identify dependencies** between components
4. **Assess risks** and potential blockers
5. **Estimate complexity** (High/Medium/Low)
6. **Present the plan** and WAIT for your explicit confirmation

## 使用例

```
ユーザー: /plan マーケットが解決したときにリアルタイム通知を追加する必要があります

エージェント (planner):
# 実装計画: リアルタイムマーケット解決通知

## 要件の言い直し
- 監視しているマーケットが解決したときにユーザーに通知を送信
- 複数の通知チャネルをサポート (アプリ内、メール、ウェブフック)
- 通知が確実に配信されることを確認
- マーケット結果とユーザーのポジション結果を含める

## 実装フェーズ

### フェーズ 1: データベーススキーマ
- 通知テーブルを追加 カラム: id, user_id, market_id, type, status, created_at
- ユーザー通知優先度テーブルをチャネル優先度用に追加
- パフォーマンスのため user_id と market_id にインデックスを作成

### フェーズ 2: 通知サービス
- lib/notifications.ts に通知サービスを作成
- BullMQ/Redis を使用して通知キューを実装
- 失敗した配信のリトライロジックを追加
- 通知テンプレートを作成

### フェーズ 3: 統合ポイント
- マーケット解決ロジックにフック (ステータスが "resolved" に変わるとき)
- マーケット内のポジション持ちのすべてのユーザーをクエリ
- 各ユーザー向けに通知をエンキュー

### フェーズ 4: フロントエンドコンポーネント
- ヘッダーに NotificationBell コンポーネントを作成
- NotificationList モーダルを追加
- Supabase サブスクリプション経由でリアルタイム更新を実装
- 通知優先度ページを追加

## 依存性
- Redis (キュー用)
- メールサービス (SendGrid/Resend)
- Supabase リアルタイムサブスクリプション

## リスク
- 高: メール配信可能性 (SPF/DKIM が必要)
- 中程度: 1000+ ユーザー/マーケットのパフォーマンス
- 中程度: マーケットが頻繁に解決する場合の通知スパム
- 低: リアルタイムサブスクリプション オーバーヘッド

## 推定複雑度: 中程度
- バックエンド: 4-6 時間
- フロントエンド: 3-4 時間
- テスト: 2-3 時間
- 合計: 9-13 時間

**確認を待っています**: この計画で進みますか? (yes/no/modify)
```

## 重要な注記

**重大**: プランナーエージェントは、「yes」または「proceed」のような明示的な肯定応答でプランを確認するまで、コードを書きません。

変更したい場合は、以下を返してください:
- 「modify: [変更内容]」
- 「different approach: [代替案]」
- 「skip phase 2 and do phase 3 first」

## 他のコマンドとの統合

計画後:
- テスト駆動開発で実装するには `/tdd` を使用
- ビルドエラーが発生した場合は `/build-and-fix` を使用
- 完了した実装をレビューするには `/code-review` を使用

## 関連エージェント

このコマンドは `planner` エージェントを呼び出します:
`~/.claude/agents/planner.md`
